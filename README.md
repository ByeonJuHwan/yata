# 유저 서비스와의 데이터 동기화

## User 데이터 동기화 전략

### 배경

MSA 환경에서 각 서비스는 독립된 데이터베이스를 가지므로, 모놀리식 아키텍처처럼 JOIN을 통한 데이터 조회가 불가능합니다.

호텔 서비스의 경우, 대부분의 비즈니스 로직에서 User 정보가 필수적으로 요구됩니다:

* 호텔 등록 시 사장님(User) 정보 필요
* 예약 생성 시 고객(User) 정보 필요
* 리뷰 작성 시 작성자(User) 정보 필요

### 고려한 접근 방식

#### 방식 1: API 호출 (동기 통신)

매 요청마다 User 서비스를 HTTP로 호출하여 데이터를 조회

```kotlin
fun 내가 등록한 호텔조회() {
    // User-Service Http 요청 -> User-Service 에서 응답이 10초이상 혹은 장애가 발생했다면..?
    
    // UserId 에 해당하는 호텔목록 조회
    
    // 응답
}
```

**문제점:**

* 응답 시간 증가 (네트워크 레이턴시)
* User 서비스 장애 시 호텔 서비스까지 영향
* User 서비스에 과도한 트래픽 집중

#### 방식 2: 데이터 동기화 (선택)

필요한 User 정보를 호텔 서비스 DB에 복제하여 관리

```kotlin
fun 내가 등록한 호텔조회() {
    // 호텔서비스 내부 DB의 User 테이블에서 User 조회
    
    // UserId 에 해당하는 호텔목록 조회
    
    // 응답
}
```



**장점:**

* 빠른 조회 성능 (로컬 DB 접근)
* User 서비스와의 느슨한 결합
* User 서비스 장애 시에도 호텔 서비스 동작 가능

**단점:**

* 데이터 정합성 관리 필요
* 저장 공간 중복 사용
* 동기화 로직 구현 및 유지보수 필요

### 데이터 정합성 유지 전략

호텔 서비스의 경우 User 정보 조회 빈도가 매우 높고 가용성이 중요하므로, 데이터 동기화 방식을 채택하여 User 서비스로부터 필요한 데이터를 로컬 DB에 복제하여 관리합니다.

#### 발생 가능한 문제

호텔 서비스 내부에 User 테이블을 관리하면, User 서비스에서 발생한 변경사항이 실시간으로 반영되지 않아 데이터 정합성이 깨질 수 있습니다.

**예시:**

* User 서비스에서 회원 탈퇴 처리 → 호텔 서비스는 여전히 활성 회원으로 인식
* User 서비스에서 이름 변경 → 호텔 서비스는 이전 이름으로 표시



이를 해결하기 위해선 결국 각 마이크로 서비스간의 통신을 통해 데이터 정합성을 맞추는 과정이 필요했고, 이벤트 기반 동기화를 통해서 이를 해결했습니다.

#### 해결 방법: 이벤트 기반 동기화

Kafka를 활용한 비동기 이벤트 스트리밍으로 데이터 정합성을 유지합니다.

**동작 방식**

1. **User 서비스**: 데이터 변경 시 이벤트 발행
   * UserCreated: 신규 회원 가입
   * UserUpdated: 회원 정보 수정 (이름, 연락처 등)
   * UserStatusChanged: 회원 상태 변경 (활성/정지/탈퇴)
2. **Kafka**: 이벤트를 토픽(user-events)에 저장
3. **호텔 서비스**: 이벤트를 구독(consume)하여 로컬 DB 업데이트



```kotlin
// User-service
fun 유저_상태_변경(userId: Long, newStatus: UserStatus) {
    // 1. DB 업데이트
    userRepository.updateStatus(userId, newStatus)
        
    // 2. 이벤트 발행 (변경 정보 포함)
    eventPublisher.publish(UserUpdatedEvent(userId, newStatus)
}

// Hotel-Management-Service  
fun 유저_상태_변경_컨슈머(event: UserUpdatedEvent) {
    // 중복 처리 방지
    if (이미_처리됨(event.eventId)) return
    
    // 로컬 User 테이블 업데이트
    userRepository.updateStatus(event.userId, event.status)
}
```

### 마치며

이벤트 기반 데이터 동기화 방식은 서비스 간 결합도를 낮추고 가용성을 높이지만, 데이터 정합성 관리와 이벤트 처리 로직이 추가로 필요합니다.

호텔 서비스의 경우 User 정보 조회 빈도가 높고 실시간성보다 가용성이 중요하므로 이 방식이 적합하다고 판단했습니다.

향후 다른 서비스(예약, 결제 등)에서도 유사한 요구사항이 발생하면 동일한 패턴을 적용해 나가도록 하겠습니다.

